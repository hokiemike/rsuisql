select
	e.ENDORSEMENT_SKEY,
	e.ENDORSEMENT_NUMBER,
	s.SUB_POLICY_NUMBER,
	s.SUB_POLICY_SUFFIX,
	e.SUB_RECORD_NUMBER,
	e.ENDORSEMENT_GROSS_PREMIUM,
	sum(l.LAYER_PREMIUM) AS [SumOfLayers],
	count(l.LAYER_PREMIUM) AS [CountOfLayers],
	(e.ENDORSEMENT_GROSS_PREMIUM - sum(l.LAYER_PREMIUM)) AS [Difference]
from
	ENDORSEMENT e
		inner join SUBMISSION s on
			e.SUB_RECORD_NUMBER = s.SUB_RECORD_NUMBER
		inner join QUOTE_BINDER q on
			s.SUB_RECORD_NUMBER = q.SUB_RECORD_NUMBER and s.QB_SEQUENCE_NO = q.QB_SEQUENCE_NO
		inner join RI_HEADER_LEVEL h on 
			e.ENDORSEMENT_SKEY = h.ENDORSEMENT_SKEY				
		left outer join RI_LAYER_LEVEL l on
			h.HEADER_LEVEL_SKEY = l.HEADER_LEVEL_SKEY
		
WHERE
	h.CLAIM_SKEY is null 
	and ENDORSEMENT_GROSS_PREMIUM > 0
	and e.ENDORSEMENT_SKEY not in (30701,60204,57308,41512,16003,28111,105868,16363,42515,
	42704,48283,44308,15999,112732,57087,30957,53334,106905,51118,50197,30649,30882,59391,
	42281,16005,16964,31037,41250,41315,30884,49306,43000,46779,21139,12118,53970,92430,30761,100571)
GROUP BY
		e.ENDORSEMENT_SKEY,
	e.ENDORSEMENT_NUMBER,
	s.SUB_POLICY_NUMBER,
	s.SUB_POLICY_SUFFIX,
	e.SUB_RECORD_NUMBER,
	e.ENDORSEMENT_GROSS_PREMIUM
HAVING
	e.ENDORSEMENT_GROSS_PREMIUM != sum(l.LAYER_PREMIUM)
